# 后台保活功能测试指南

## 测试前准备

### 1. 设备设置
- 确保设备已开启"后台应用刷新"功能
  - 设置 → 通用 → 后台应用刷新 → Focus Buddy → 开启
- 确保应用有通知权限
  - 设置 → 通知 → Focus Buddy → 允许通知
- 应用会自动检测权限状态并提示用户设置

### 2. 应用设置
- 确保应用已正确安装并运行
- 检查控制台日志，确认后台任务已注册

## 测试步骤

### 测试一：基础后台计时功能

1. **启动计时器**
   - 打开应用，设置一个较短的专注时间（如2分钟）
   - 点击开始专注
   - 确认计时器开始倒计时

2. **切换到后台**
   - 立即按Home键或切换到其他应用
   - 等待30秒-1分钟

3. **切回应用**
   - 重新打开Focus Buddy
   - 检查剩余时间是否准确
   - 查看控制台日志，确认后台时间补偿

**预期结果：**
- 剩余时间应该准确反映实际经过的时间
- 控制台应该显示"后台时间补偿: XX秒"

### 测试二：长时间后台运行

1. **设置较长计时**
   - 设置5-10分钟的专注时间
   - 启动计时器

2. **长时间后台运行**
   - 切换到其他应用
   - 等待3-5分钟
   - 期间可以查看通知中心是否有计时器通知

3. **切回应用**
   - 检查时间是否准确
   - 确认UI状态同步正确

**预期结果：**
- 时间计算准确
- UI显示正确的剩余时间
- 动画和音乐状态正常

### 测试三：计时完成通知

1. **设置短时间计时**
   - 设置1-2分钟的专注时间
   - 启动计时器

2. **切换到后台**
   - 切换到其他应用
   - 等待计时完成

3. **检查通知**
   - 查看是否收到计时完成通知
   - 通知内容是否正确（工作/休息模式）

**预期结果：**
- 收到计时完成通知
- 通知标题和内容正确
- 通知有声音提醒

### 测试四：暂停和恢复功能

1. **启动计时器**
   - 设置3-5分钟的专注时间
   - 启动计时器

2. **暂停计时器**
   - 点击暂停按钮
   - 切换到后台等待1-2分钟

3. **恢复计时器**
   - 切回应用
   - 点击恢复按钮
   - 检查时间是否正确

**预期结果：**
- 暂停时时间停止
- 恢复后时间继续准确计算
- 后台时间被正确补偿

### 测试五：应用重启恢复

1. **启动计时器**
   - 设置较长的专注时间（如10分钟）
   - 启动计时器

2. **强制关闭应用**
   - 双击Home键，上滑关闭应用
   - 等待1-2分钟

3. **重新打开应用**
   - 重新启动Focus Buddy
   - 检查计时器状态

**预期结果：**
- 应用重启后计时器状态正确
- 剩余时间准确
- 可以继续使用

## 调试信息

### 控制台日志关键词
- `BackgroundTimerManager: 初始化后台计时管理器`
- `BackgroundTimerManager: 后台任务已注册`
- `BackgroundTimerManager: 启动计时器`
- `BackgroundTimerManager: 应用即将进入后台`
- `BackgroundTimerManager: 应用回到前台`
- `BackgroundTimerManager: 后台时间补偿: XX秒`
- `BackgroundTimerManager: 计时器完成`

### 常见问题排查

1. **时间不准确**
   - 检查后台应用刷新是否开启
   - 查看控制台日志确认后台任务执行
   - 确认应用没有被系统强制关闭

2. **没有收到通知**
   - 检查通知权限设置
   - 确认通知中心设置
   - 查看控制台日志确认通知设置成功

3. **应用重启后状态丢失**
   - 检查UserDefaults数据保存
   - 确认BackgroundTimerManager状态恢复
   - 查看控制台日志确认初始化过程

## 性能测试

### 电池消耗测试
1. 连续使用后台计时功能1小时
2. 检查电池消耗情况
3. 确认没有异常耗电

### 内存使用测试
1. 长时间运行应用
2. 检查内存使用情况
3. 确认没有内存泄漏

## 测试报告模板

```
测试日期：____年____月____日
测试设备：iPhone ____ (iOS ____)
测试版本：Focus Buddy v1.1.0

测试结果：
□ 基础后台计时功能 - 通过/失败
□ 长时间后台运行 - 通过/失败  
□ 计时完成通知 - 通过/失败
□ 暂停和恢复功能 - 通过/失败
□ 应用重启恢复 - 通过/失败

问题记录：
1. ________________
2. ________________
3. ________________

建议改进：
1. ________________
2. ________________
3. ________________
```

## 注意事项

1. **系统限制**：iOS系统可能会限制后台运行时间，这是正常现象
2. **电池优化**：长时间后台运行可能影响电池寿命
3. **用户设置**：用户需要手动开启相关权限
4. **网络环境**：某些功能可能受网络环境影响

## 联系支持

如果在测试过程中遇到问题，请：
1. 记录详细的测试步骤
2. 保存控制台日志
3. 截图问题现象
4. 联系开发团队
