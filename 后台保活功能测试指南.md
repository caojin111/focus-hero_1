# 后台保活功能测试指南

## 测试前准备

### 1. 权限设置
确保以下权限已正确设置：
- 后台应用刷新：设置 → 通用 → 后台应用刷新 → Focus Buddy → 开启
- 通知权限：应用内已授权通知权限

### 2. 应用配置
- 确保应用已重新编译并安装最新版本
- 确保 Info.plist 包含音频后台模式配置

## 测试步骤

### 测试1：音频保活验证测试

**步骤：**
1. 打开应用 → 设置 → Background Timer Permissions
2. 点击"开始测试"按钮
3. 观察音频会话状态和静音播放器状态
4. 切换到其他应用或锁屏设备
5. 等待30秒后切回应用
6. 查看测试日志和状态

**预期结果：**
- 音频会话状态显示"✅ 活跃"
- 静音播放器状态显示"✅ 播放中"
- 测试日志显示正常的状态检查信息

**关键验证点：**
```
✅ 音频会话设置成功
✅ 静音音频播放器已创建并启动
🔇 播放器音量: 0.0 (完全静音)
📊 音频会话状态检查:
- 音频会话活跃: true
- 静音播放器播放: true
```

### 测试2：基础后台计时测试

**步骤：**
1. 启动应用，进入主界面
2. 设置工作时间为 2 分钟
3. 点击开始计时
4. 立即切换到其他应用（如 Safari）
5. 等待 1-2 分钟
6. 切回应用

**预期结果：**
- 计时器应该继续运行
- 剩余时间应该正确减少
- 控制台应该显示音频保活相关日志

**验证日志：**
```
BackgroundTimerManager: 音频保活已启动
AudioManager: 音频会话设置成功，已启用后台保活
```

### 测试2：锁屏状态测试

**步骤：**
1. 启动计时器（设置 3 分钟）
2. 锁屏设备
3. 等待 2-3 分钟
4. 解锁设备并切回应用

**预期结果：**
- 计时器应该继续运行
- 剩余时间应该正确计算
- 应该收到计时完成通知

### 测试3：长时间后台测试

**步骤：**
1. 启动计时器（设置 5 分钟）
2. 切换到其他应用
3. 使用其他应用 3-4 分钟
4. 切回应用

**预期结果：**
- 计时器应该准确运行
- 时间计算应该精确
- 完成后应该收到通知

### 测试4：音频中断测试

**步骤：**
1. 启动计时器
2. 播放音乐或视频
3. 切换到其他应用
4. 等待一段时间后切回

**预期结果：**
- 计时器应该继续运行
- 音频会话应该正确处理中断
- 控制台应该显示中断处理日志

### 测试3：通知功能测试

**步骤：**
1. 启动计时器（设置 1-2 分钟）
2. 切换到其他应用
3. 等待计时完成
4. 检查是否收到完成通知

**预期结果：**
- 专注开始时不会收到通知
- 专注完成时会收到英文通知：
  - 工作模式：`"Focus Completed!"` + `"Great job! You've completed your focus session!"`
  - 休息模式：`"Break Finished!"` + `"Break time is over. Ready for your next focus session!"`

**验证日志：**
```
BackgroundTimerManager: 专注开始，不发送开始通知
BackgroundTimerManager: 计时器完成
BackgroundTimerManager: 完成通知已发送
```

## 故障排除

### 问题1：计时器在后台停止

**可能原因：**
- 后台应用刷新权限未开启
- 音频会话配置错误
- 系统资源不足

**解决方案：**
1. 检查权限设置
2. 重启应用
3. 查看控制台日志

### 问题2：时间计算不准确

**可能原因：**
- 后台时间补偿逻辑错误
- 状态保存/恢复失败

**解决方案：**
1. 检查 UserDefaults 中的状态
2. 查看后台时间补偿日志
3. 重新启动计时器

### 问题3：没有收到通知

**可能原因：**
- 通知权限未授权
- 通知设置被禁用

**解决方案：**
1. 检查通知权限
2. 在设置中确认通知已开启
3. 测试本地通知功能

## 日志分析

### 关键日志信息

**正常启动：**
```
BackgroundTimerManager: 音频会话保活已设置
BackgroundTimerManager: 静音音频播放器已创建
BackgroundTimerManager: 音频保活已启动
```

**后台运行：**
```
BackgroundTimerManager: 应用即将进入后台
BackgroundTimerManager: 保存计时器状态
BackgroundTimerManager: 应用回到前台
BackgroundTimerManager: 后台时间补偿: X秒
```

**权限问题：**
```
AppDelegate: 后台应用刷新被拒绝
BackgroundTimerManager: 通知权限被拒绝
```

## 性能监控

### 电池使用
- 音频保活会增加电池消耗
- 正常使用下增加约 5-10%
- 如果消耗过高，检查是否有音频循环问题

### 内存使用
- 静音音频播放器占用内存很少
- 正常情况下不会造成内存泄漏
- 监控内存使用情况

## 兼容性测试

### iOS 版本
- iOS 16.0+：完全支持
- iOS 15.x：部分功能可能受限
- iOS 14.x：不推荐使用

### 设备类型
- iPhone：完全支持
- iPad：支持，但后台限制更严格
- 模拟器：功能受限，建议真机测试

## 用户指导

### 首次使用
1. 引导用户开启后台应用刷新权限
2. 请求通知权限
3. 解释音频保活的工作原理

### 日常使用
1. 正常启动计时器即可
2. 可以放心切换到其他应用
3. 完成后会收到通知提醒

### 问题反馈
如果遇到问题，请提供：
- 设备型号和 iOS 版本
- 具体的操作步骤
- 控制台日志信息
- 权限设置状态
