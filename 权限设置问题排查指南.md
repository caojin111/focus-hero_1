# 权限设置问题排查指南

## 问题描述
1. 卸载重装后没有看到权限请求弹窗
2. 在设置 → 通用 → 后台应用刷新列表里找不到Focus Buddy

## 问题分析

### 1. 权限请求弹窗不显示的原因

**可能原因：**
- 应用没有正确配置后台模式
- 权限检查时机不对
- 系统权限状态检查有延迟

**解决方案：**

#### 步骤1：检查Info.plist配置
确保Info.plist包含以下配置：
```xml
<key>UIBackgroundModes</key>
<array>
    <string>background-processing</string>
    <string>background-fetch</string>
    <string>background-app-refresh</string>
</array>
<key>BGTaskSchedulerPermittedIdentifiers</key>
<array>
    <string>com.focusbuddy.timer</string>
</array>
```

#### 步骤2：手动触发权限检查
在应用启动后，手动检查权限状态：
1. 打开应用
2. 等待1-2秒
3. 查看控制台日志，确认权限检查是否执行

#### 步骤3：手动设置权限
如果自动检测不工作，可以手动设置：
1. 设置 → 通用 → 后台应用刷新
2. 找到Focus Buddy（如果存在）
3. 开启后台应用刷新

### 2. 后台应用刷新列表找不到应用

**可能原因：**
- 应用还没有使用过后台功能
- 系统需要应用先尝试使用后台功能
- 权限配置不完整

**解决方案：**

#### 步骤1：触发后台功能使用
1. 启动计时器
2. 切换到其他应用
3. 等待30秒-1分钟
4. 切回应用
5. 重复几次这个操作

#### 步骤2：检查应用权限
1. 设置 → 隐私与安全性 → 后台应用刷新
2. 查看是否有Focus Buddy
3. 如果没有，继续下一步

#### 步骤3：强制刷新权限列表
1. 完全关闭应用（双击Home键，上滑关闭）
2. 重新启动应用
3. 使用计时器功能
4. 再次检查设置

## 调试步骤

### 1. 查看控制台日志
运行应用后，查看Xcode控制台，应该看到：
```
AppDelegate: 开始请求后台刷新权限
AppDelegate: 当前后台刷新状态: X
MainView: 检查后台权限状态: X
```

### 2. 权限状态说明
- `0`: 不可用 (denied)
- `1`: 可用 (available)  
- `2`: 受限制 (restricted)

### 3. 手动测试权限
```swift
// 在控制台或代码中执行
let status = UIApplication.shared.backgroundRefreshStatus
print("后台刷新状态: \(status.rawValue)")
```

## 常见问题解决

### 问题1：权限请求弹窗不显示
**解决：**
1. 确保应用完全重新安装
2. 检查Info.plist配置
3. 手动触发权限检查

### 问题2：后台应用刷新列表为空
**解决：**
1. 使用应用的后台功能
2. 等待系统识别
3. 重启设备

### 问题3：权限设置后仍然不工作
**解决：**
1. 检查应用是否正确使用后台API
2. 确认BGTaskScheduler配置
3. 查看系统日志

## 测试验证

### 测试1：权限检查
1. 启动应用
2. 查看控制台日志
3. 确认权限状态检查执行

### 测试2：后台功能
1. 启动计时器
2. 切换到其他应用
3. 等待1-2分钟
4. 切回应用检查时间

### 测试3：权限设置
1. 检查设置中的权限列表
2. 确认Focus Buddy出现
3. 开启后台应用刷新

## 联系支持

如果问题仍然存在，请提供：
1. 控制台日志输出
2. 设备型号和iOS版本
3. 具体的操作步骤
4. 权限设置截图

## 注意事项

1. **iOS版本差异**：不同iOS版本的后台权限机制可能不同
2. **设备限制**：某些设备可能有额外的限制
3. **系统设置**：确保系统设置中没有禁用后台功能
4. **应用状态**：应用需要先使用后台功能才能出现在权限列表中
